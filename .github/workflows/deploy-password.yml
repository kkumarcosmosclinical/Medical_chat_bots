name: Deploy Medical Chatbot (Password Auth)

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies for testing
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run syntax checks
        run: |
          python -m py_compile main.py
          python -m py_compile app.py
          python -m py_compile config.py
          echo "‚úì All Python files are valid"
      
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
      
      - name: Create Backup on Server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "cd ${REMOTE_DIR} && mkdir -p backups && tar -czf backups/backup_\$(date +%Y%m%d_%H%M%S).tar.gz *.py chat_functions Embedding_fuctions database Excel_chat_bot 2>/dev/null || echo 'First deployment'"
      
      - name: Deploy to Server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          echo "üì¶ Uploading files to server..."
          
          # Upload main Python files
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no main.py app.py config.py requirements.txt ${SERVER_USER}@${SERVER_IP}:${REMOTE_DIR}/
          
          # Upload directories
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no -r chat_functions Embedding_fuctions database Excel_chat_bot ${SERVER_USER}@${SERVER_IP}:${REMOTE_DIR}/
          
          # Upload utility scripts
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no fix_permissions.sh fix_dirs.py FIX_CHROMADB_PERMISSIONS.sh start.sh run_app.sh ${SERVER_USER}@${SERVER_IP}:${REMOTE_DIR}/
          
          echo "‚úì Files uploaded successfully"
      
      - name: Install Dependencies (Conda Base)
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          echo "üì¶ Installing dependencies in conda base environment..."
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "cd ${REMOTE_DIR} && source ~/miniconda3/etc/profile.d/conda.sh && conda activate base && pip install -r requirements.txt"
          echo "‚úì Dependencies installed"
      
      - name: Fix Permissions
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          echo "üîß Fixing permissions..."
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "cd ${REMOTE_DIR} && chmod +x *.sh && ./fix_permissions.sh && source ~/miniconda3/etc/profile.d/conda.sh && conda activate base && python fix_dirs.py"
          echo "‚úì Permissions fixed"
      
      - name: Stop Existing Application
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          echo "üõë Stopping existing application..."
          sshpass -p "$SERVER_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            ${SERVER_USER}@${SERVER_IP} \
            'PID=$(pgrep -f "python main.py" | head -n1); if [ ! -z "$PID" ]; then echo "Found process $PID, stopping..."; kill $PID 2>/dev/null || true; sleep 2; kill -9 $PID 2>/dev/null || true; echo "Process stopped"; else echo "No existing process found"; fi' || true
          sleep 1
          echo "‚úì Existing processes stopped"
      
      - name: Start Application
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          echo "üöÄ Starting application..."
          sshpass -p "$SERVER_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            ${SERVER_USER}@${SERVER_IP} \
            "cd ${REMOTE_DIR} && chmod +x run_app.sh && nohup ./run_app.sh </dev/null >app.log 2>&1 & PID=\$!; echo \"Started with PID: \$PID\"; exit 0"
          sleep 3
          echo "‚úì Application started"
      
      - name: Verify Deployment
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR || '/home/krishan/projects/Medicalchatbot' }}
        run: |
          echo "üîç Verifying deployment..."
          
          # Wait a bit more for application to fully start
          sleep 3
          
          # Check if process is running
          if sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "ps aux | grep 'python main.py' | grep -v grep" > /dev/null 2>&1; then
            echo "‚úì Application process is running"
          else
            echo "‚ö† Application process not found, checking logs..."
            if sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "test -f ${REMOTE_DIR}/app.log"; then
              echo "Last 50 lines of app.log:"
              sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "tail -50 ${REMOTE_DIR}/app.log"
            else
              echo "‚ö† app.log not found - application may have failed to start"
            fi
            echo "Note: Application may still be starting up..."
          fi
          
          # Check API health
          echo "Checking API endpoint..."
          HTTP_CODE=$(sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "curl -f http://localhost:5001/docs -o /dev/null -s -w '%{http_code}' 2>/dev/null || echo '000'")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úì API is responding (HTTP $HTTP_CODE)"
          else
            echo "‚ö† API check returned: HTTP $HTTP_CODE (may still be starting)"
          fi
      
      - name: Deployment Summary
        if: always()
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "========================================"
            echo "‚úÖ Deployment Successful!"
            echo "========================================"
            echo ""
            echo "üîó Application URL: http://${SERVER_IP}:5001"
            echo "üìö API Docs: http://${SERVER_IP}:5001/docs"
          else
            echo "========================================"
            echo "‚ùå Deployment Failed!"
            echo "========================================"
            exit 1
          fi

